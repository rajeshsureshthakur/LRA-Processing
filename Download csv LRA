import java.io.*;
import java.net.URL;
import java.net.URLConnection;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

public class CsvDownloader {
    private final String baseUrl;

    public CsvDownloader(String baseUrl) {
        this.baseUrl = baseUrl;
    }

    public void downloadCsvFile(String reportId, String outputPath) {
        try {
            String endpoint = String.format("/%s/Report4.csv?lang=en-us", reportId);
            URL url = new URL(baseUrl + endpoint);
            System.out.println("Downloading from URL: " + url);

            URLConnection connection = url.openConnection();
            
            // Set headers to mimic browser
            connection.setRequestProperty("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36");
            connection.setRequestProperty("Accept", "text/csv,application/csv,*/*");
            
            // Get input stream
            try (InputStream in = connection.getInputStream();
                 FileOutputStream out = new FileOutputStream(outputPath)) {
                
                // Create buffer for reading
                byte[] buffer = new byte[4096];
                int length;
                
                // Read from input stream and write to file
                while ((length = in.read(buffer)) > 0) {
                    out.write(buffer, 0, length);
                }
                
                System.out.println("File downloaded successfully to: " + outputPath);
                System.out.println("File size: " + new File(outputPath).length() + " bytes");

                // Preview first few bytes to verify content
                byte[] preview = Files.readAllBytes(Paths.get(outputPath));
                String content = new String(preview, 0, Math.min(preview.length, 100));
                System.out.println("Content preview: " + content);
            }

        } catch (Exception e) {
            System.err.println("Error downloading file: " + e.getMessage());
            e.printStackTrace();
        }
    }

    public static void main(String[] args) {
        String baseUrl = "https://your-server-url";  // Replace with your server URL
        CsvDownloader downloader = new CsvDownloader(baseUrl);
        
        downloader.downloadCsvFile("81328", "C:/Downloads/Report.csv");  // Adjust path as needed
    }
}
